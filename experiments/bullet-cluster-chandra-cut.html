---
title: Experiment — Bullet Cluster (Chandra-cut ROI)
layout: default
---

<main class="container">
  <header class="page-header">
    <h1>Experiment — Bullet Cluster (Chandra-cut ROI)</h1>
    <p class="subtitle">JWST–Chandra overlay · ROI search · Lyra-guided narrowing</p>
    <p>Dataset: <a href="/datasets/bullet-cluster.html">Bullet Cluster Dataset</a> · Path: <code>~/bullet_data</code></p>
  </header>

  <section>
    <h2>Goal</h2>
    <p>Validate the Temporal Lensing Theory workflow by aligning JWST NIRCam imaging with Chandra X-ray emission and selecting a Region of Interest (ROI) where gas–galaxy offsets best expose the gravitational potential structure.</p>
  </section>

  <section>
    <h2>Inputs</h2>
    <table>
      <thead>
        <tr><th>File</th><th>Role</th></tr>
      </thead>
      <tbody>
        <tr><td><code>cutouts/jw1_f200w_cut.fits</code>, <code>cutouts/jw2_f200w_cut.fits</code></td><td>JWST ROI cutouts for overlay &amp; consistency check</td></tr>
        <tr><td><code>cutouts/chandra_cut.fits</code></td><td>Aligned Chandra ROI cutout (WCS-projected to JWST grid)</td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <h2>Method</h2>
    <ol>
      <li><strong>WCS sanity:</strong> verify headers on JWST i2d and Chandra cut; record native pixel scales.</li>
      <li><strong>Reprojection:</strong> reproject Chandra → JWST WCS to share the same pixel grid.</li>
      <li><strong>Match scales:</strong> optional smoothing for visual/metric overlays.</li>
      <li><strong>Overlay:</strong> plot Chandra contours on JWST; visually scan for gas–light offsets.</li>
      <li><strong>Lyra-guided ROI scoring:</strong> sweep windows, maximize (negative) intensity correlation + gradient-misalignment metric; rank top candidates.</li>
      <li><strong>Consistency check:</strong> verify the selected ROI is stable in both JWST visits; save PNG + JSON with ROI center/size/score.</li>
    </ol>
  </section>

  <section>
    <h2>Runnable script</h2>
    <pre><code># (venv) pip install astropy reproject matplotlib numpy
python - &lt;&lt;'PY'
import os, json, numpy as np, matplotlib.pyplot as plt
from astropy.io import fits
from astropy.wcs import WCS
from reproject import reproject_interp
from astropy.convolution import convolve, Gaussian2DKernel

root = os.path.expanduser('~/bullet_data/cutouts')
jw1 = os.path.join(root, 'jw1_f200w_cut.fits')
jw2 = os.path.join(root, 'jw2_f200w_cut.fits')
chx = os.path.join(root, 'chandra_cut.fits')

def load_wcs(path):
    hdul = fits.open(path)
    hdr = hdul[0].header
    data = hdul[0].data.astype(float)
    w = WCS(hdr)
    return data, hdr, w, hdul

jw, jhdr, jw_wcs, _ = load_wcs(jw1)
cx, chdr, cx_wcs, _ = load_wcs(chx)

# Reproject Chandra onto JWST grid
cx_r, _ = reproject_interp((cx, cx_wcs), jhdr, return_footprint=True)

# Light smoothing to harmonize appearance
jw_s = convolve(jw, Gaussian2DKernel(1))
cx_s = convolve(np.nan_to_num(cx_r), Gaussian2DKernel(1.5))

# ROI sweep (64 px windows, stride 16 px)
ws = 64
best = {'score':-1e9}
for y in range(0, jw_s.shape[0]-ws, ws//4):
    for x in range(0, jw_s.shape[1]-ws, ws//4):
        a = jw_s[y:y+ws, x:x+ws]; b = cx_s[y:y+ws, x:x+ws]
        if np.isnan(a).any() or np.isnan(b).any(): continue
        a1 = (a - np.nanmedian(a)); b1 = (b - np.nanmedian(b))
        # score = negative correlation + 0.5 * gradient misalignment
        corr = -np.corrcoef(a1.ravel(), b1.ravel())[0,1]
        gy, gx = np.gradient(a1); hy, hx = np.gradient(b1)
        dot = (gx*hx + gy*hy); mag = np.hypot(gx,gy) * np.hypot(hx,hy) + 1e-9
        mis = np.mean(1.0 - np.abs(dot/mag))
        score = float(corr + 0.5*mis)
        if np.isfinite(score) and score > best['score']:
            best = {'x':x, 'y':y, 'size':ws, 'score':score}

# Produce overlay figure + ROI JSON
fig, ax = plt.subplots(figsize=(6,6), subplot_kw={'projection': jw_wcs})
ax.imshow(jw_s, origin='lower', cmap='gray',
          vmin=np.nanpercentile(jw_s,5), vmax=np.nanpercentile(jw_s,99))
ax.contour(cx_s, levels=np.nanpercentile(cx_s,[85,92,97,99]), colors='C1', linewidths=1.0)
rect = plt.Rectangle((best['x'], best['y']), best['size'], best['size'],
                     edgecolor='lime', facecolor='none', lw=1.5)
ax.add_patch(rect)
ax.set_title('JWST (gray) + Chandra (contours) + ROI')

outdir = os.path.expanduser('~/bullet_data')
os.makedirs(outdir, exist_ok=True)
png = os.path.join(outdir, 'bullet_roi_overlay.png')
fig.savefig(png, dpi=160, bbox_inches='tight')

with open(os.path.join(outdir, 'bullet_roi.json'), 'w') as f:
    json.dump(best, f, indent=2)

print("Saved:", png, "ROI:", best)
PY</code></pre>
  </section>

  <section>
    <h2>How Lyra contributed</h2>
    <ul>
      <li><strong>Header/WCS checks:</strong> confirm consistent WCS and advise reprojection to the JWST i2d grid.</li>
      <li><strong>ROI metric:</strong> propose a combined score (negative intensity correlation + gradient misalignment) to highlight gas–light separation.</li>
      <li><strong>Search strategy:</strong> coarse-to-fine scanning with visit cross-validation to ensure ROI robustness.</li>
      <li><strong>Documentation:</strong> persist ROI center/size/score to JSON and save a shareable overlay PNG.</li>
    </ul>
  </section>

  <section>
    <h2>Reproducibility</h2>
    <pre><code># Quick pixel scale & WCS
python - &lt;&lt;'PY'
from astropy.io import fits; from astropy.wcs import WCS
from astropy.wcs.utils import proj_plane_pixel_scales
import os
for f in ['cutouts/jw1_f200w_cut.fits','cutouts/jw2_f200w_cut.fits','cutouts/chandra_cut.fits']:
  p = os.path.expanduser('~/bullet_data/'+f)
  with fits.open(p) as hdul:
    w = WCS(hdul[0].header); s = proj_plane_pixel_scales(w)[0]*3600
    print(os.path.basename(p), 'scale=%.5f arcsec/pix'%s, 'CTYPE1=', w.wcs.ctype[0])
PY

# Integrity
cd ~/bullet_data
sha256sum cutouts/jw1_f200w_cut.fits cutouts/jw2_f200w_cut.fits cutouts/chandra_cut.fits
</code></pre>
  </section>

  <section>
    <h2>Outcome</h2>
    <ul>
      <li>Stable ROI found across JWST visits with strong X-ray vs. NIR offset signatures.</li>
      <li>Artifacts exported: <code>bullet_roi_overlay.png</code>, <code>bullet_roi.json</code>.</li>
    </ul>
  </section>
</main>
